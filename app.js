const data = {
  meta: {
    timezone: "America/New_York",
    uploadUrl: "https://photos.app.goo.gl/akGScybc5DNwRKex8",
  },
  segments: {
    cocktail: {
      start: "17:30",
      end: "18:30",
      items: [
        {
          id: "cocktail-1",
          title: "Signature Sip",
          type: "photo",
          vibe: "easy",
          prompt: "Photograph your drink like it’s a product ad.",
        },
        {
          id: "cocktail-2",
          title: "Cheers Clip",
          type: "video",
          vibe: "easy",
          prompt: "Record a 5-second cheers with your group.",
        },
        {
          id: "cocktail-3",
          title: "Fit Check",
          type: "photo",
          vibe: "easy",
          prompt: "Full-body outfit photo. Clean background.",
        },
        {
          id: "cocktail-4",
          title: "The Big Laugh",
          type: "photo",
          vibe: "medium",
          prompt: "Capture the biggest laugh you see during cocktail hour.",
        },
        {
          id: "cocktail-5",
          title: "Appetizer Spotlight",
          type: "photo",
          vibe: "easy",
          prompt: "Photograph the best appetizer before it’s gone.",
        },
        {
          id: "cocktail-6",
          title: "Compliment Cam",
          type: "video",
          vibe: "easy",
          prompt: "Record a 6-second compliment about the couple or the vibe.",
        },
        {
          id: "cocktail-7",
          title: "Old Friends",
          type: "photo",
          vibe: "easy",
          prompt: "Candid photo of two people clearly catching up.",
        },
        {
          id: "cocktail-8",
          title: "New Friend",
          type: "photo",
          vibe: "medium",
          prompt: "Take a photo with someone you just met tonight.",
        },
        {
          id: "cocktail-9",
          title: "Venue Detail Hunt",
          type: "photo",
          vibe: "medium",
          prompt: "Find the prettiest detail (flowers/signage) and photograph it.",
        },
        {
          id: "cocktail-10",
          title: "Photojournalist Moment",
          type: "photo",
          vibe: "medium",
          prompt: "Take a candid like you’re shooting a documentary.",
        },
        {
          id: "cocktail-11",
          title: "The Toast Pose",
          type: "photo",
          vibe: "easy",
          prompt: "Group photo holding glasses up mid-toast.",
        },
        {
          id: "cocktail-12",
          title: "Laugh + Cheers",
          type: "video",
          vibe: "medium",
          prompt: "Record a 6-second clip of laughter turning into a cheers.",
        },
        {
          id: "cocktail-13",
          title: "Best Accessory",
          type: "photo",
          vibe: "easy",
          prompt: "Close-up of the best accessory you see (watch, earrings, etc.).",
        },
        {
          id: "cocktail-14",
          title: "Shoes Shot",
          type: "photo",
          vibe: "easy",
          prompt: "Take a clean shot of someone’s shoes (with permission).",
        },
        {
          id: "cocktail-15",
          title: "Three-Person Selfie",
          type: "photo",
          vibe: "easy",
          prompt: "Selfie with exactly three people in frame.",
        },
        {
          id: "cocktail-16",
          title: "Five-Person Selfie",
          type: "photo",
          vibe: "medium",
          prompt: "Selfie with exactly five people in frame.",
        },
        {
          id: "cocktail-17",
          title: "We’re Here!",
          type: "video",
          vibe: "easy",
          prompt: "Record a 4-second ‘We’re here for Zack & Sean!’ clip.",
        },
        {
          id: "cocktail-18",
          title: "The Photo Line",
          type: "photo",
          vibe: "medium",
          prompt: "Snap the most photogenic line you see (bar/food).",
        },
        {
          id: "cocktail-19",
          title: "Best Smile",
          type: "photo",
          vibe: "medium",
          prompt: "Capture someone mid-smile, not posed.",
        },
        {
          id: "cocktail-20",
          title: "Crowd Wide",
          type: "photo",
          vibe: "easy",
          prompt: "Wide shot of cocktail hour showing the whole vibe.",
        },
        {
          id: "cocktail-21",
          title: "Clink Close-Up",
          type: "video",
          vibe: "medium",
          prompt: "Tight 3-second clip of glasses clinking.",
        },
        {
          id: "cocktail-22",
          title: "The Entrance Sign",
          type: "photo",
          vibe: "easy",
          prompt: "Photograph the entrance sign or welcome sign.",
        },
        {
          id: "cocktail-23",
          title: "The Group Triangle",
          type: "photo",
          vibe: "medium",
          prompt: "Three people posing in a triangle formation.",
        },
        {
          id: "cocktail-24",
          title: "The Side Profile",
          type: "photo",
          vibe: "medium",
          prompt: "Capture a candid side-profile conversation shot.",
        },
        {
          id: "cocktail-25",
          title: "The Overhead Plate",
          type: "photo",
          vibe: "medium",
          prompt: "Overhead photo of a plate + drink (flat-lay style).",
        },
        {
          id: "cocktail-26",
          title: "The Laughing Pair",
          type: "photo",
          vibe: "easy",
          prompt: "Photo of two people laughing together.",
        },
        {
          id: "cocktail-27",
          title: "The Nice to Meet You",
          type: "video",
          vibe: "medium",
          prompt: "Record a 6-second intro between two people meeting.",
        },
        {
          id: "cocktail-28",
          title: "The Toast Practice",
          type: "video",
          vibe: "easy",
          prompt: "Record a 5-second mini-toast from your group.",
        },
        {
          id: "cocktail-29",
          title: "The Model Walk",
          type: "video",
          vibe: "chaos",
          prompt: "Record a 6-second runway walk from a friend.",
        },
        {
          id: "cocktail-30",
          title: "The Magazine Cover",
          type: "photo",
          vibe: "medium",
          prompt: "Pose someone like they’re on a magazine cover.",
        },
        {
          id: "cocktail-31",
          title: "The Window Light",
          type: "photo",
          vibe: "medium",
          prompt: "Find good natural light and take a flattering shot.",
        },
        {
          id: "cocktail-32",
          title: "The Mirror Moment",
          type: "photo",
          vibe: "medium",
          prompt: "Mirror selfie if there’s a good mirror (no blocking traffic).",
        },
        {
          id: "cocktail-33",
          title: "The Tiny Detail",
          type: "photo",
          vibe: "easy",
          prompt: "Zoom in on a small pretty detail: napkin, card, centerpiece.",
        },
        {
          id: "cocktail-34",
          title: "The Handshake",
          type: "photo",
          vibe: "medium",
          prompt: "Candid of a handshake/hello moment.",
        },
        {
          id: "cocktail-35",
          title: "The Cheers Boomerang",
          type: "video",
          vibe: "medium",
          prompt: "Boomerang-style clip of cheers (3 seconds).",
        },
        {
          id: "cocktail-36",
          title: "The Surprise Reunion",
          type: "photo",
          vibe: "medium",
          prompt: "Capture someone surprised to see a friend.",
        },
        {
          id: "cocktail-37",
          title: "The Pose Off",
          type: "photo",
          vibe: "chaos",
          prompt: "Two friends do a pose-off. Capture the best pose.",
        },
        {
          id: "cocktail-38",
          title: "The Serious Face",
          type: "photo",
          vibe: "chaos",
          prompt: "Group photo where everyone looks extremely serious.",
        },
        {
          id: "cocktail-39",
          title: "The Tiny Dance",
          type: "video",
          vibe: "easy",
          prompt: "3-second clip of someone doing a tiny dance.",
        },
        {
          id: "cocktail-40",
          title: "The Name Game",
          type: "video",
          vibe: "medium",
          prompt: "Ask someone to say their name + how they know the couple.",
        },
        {
          id: "cocktail-41",
          title: "The Best Angle",
          type: "photo",
          vibe: "medium",
          prompt: "Take the best angled photo you can of your group.",
        },
        {
          id: "cocktail-42",
          title: "The Candid Chef",
          type: "photo",
          vibe: "medium",
          prompt: "Photo of food being served/prepared (if visible).",
        },
        {
          id: "cocktail-43",
          title: "The Cheers With Strangers",
          type: "photo",
          vibe: "medium",
          prompt: "Photo with another group cheering together.",
        },
        {
          id: "cocktail-44",
          title: "The Golden Glow",
          type: "photo",
          vibe: "medium",
          prompt: "Find warm lighting and capture the glow.",
        },
        {
          id: "cocktail-45",
          title: "The Hands With Drinks",
          type: "photo",
          vibe: "easy",
          prompt: "Photo of just hands holding drinks.",
        },
        {
          id: "cocktail-46",
          title: "The Background Blur",
          type: "photo",
          vibe: "chaos",
          prompt: "Portrait photo with a blurred background.",
        },
        {
          id: "cocktail-47",
          title: "The Walking Shot",
          type: "video",
          vibe: "medium",
          prompt: "6-second clip walking through cocktail hour vibes.",
        },
        {
          id: "cocktail-48",
          title: "The One Word",
          type: "video",
          vibe: "easy",
          prompt: "Ask someone: one word for tonight so far.",
        },
        {
          id: "cocktail-49",
          title: "The Cheers Countdown",
          type: "video",
          vibe: "medium",
          prompt: "3-2-1 cheers clip (5 seconds).",
        },
        {
          id: "cocktail-50",
          title: "The Best Duo",
          type: "photo",
          vibe: "easy",
          prompt: "Photo of the best duo you see.",
        },
      ],
    },
    reception: {
      start: "18:30",
      end: "22:30",
      items: [
        {
          id: "reception-51",
          title: "Dance Floor Proof",
          type: "video",
          vibe: "easy",
          prompt: "Record 6 seconds of the dance floor at peak energy.",
        },
        {
          id: "reception-52",
          title: "Iconic Pose",
          type: "photo",
          vibe: "easy",
          prompt: "Your group hits one ridiculous pose. Capture it.",
        },
        {
          id: "reception-53",
          title: "Spin Shot",
          type: "video",
          vibe: "medium",
          prompt: "Slow 360° pan of the dance floor (under 7 seconds).",
        },
        {
          id: "reception-54",
          title: "Reaction Cam",
          type: "photo",
          vibe: "medium",
          prompt: "Capture the best reaction during a toast or speech.",
        },
        {
          id: "reception-55",
          title: "Table Toast",
          type: "video",
          vibe: "easy",
          prompt: "3-second toast from your table to the couple.",
        },
        {
          id: "reception-56",
          title: "Candid Conversation",
          type: "photo",
          vibe: "medium",
          prompt: "Candid of someone mid-story.",
        },
        {
          id: "reception-57",
          title: "The Hands Up",
          type: "photo",
          vibe: "easy",
          prompt: "Photo of people with hands up during a song.",
        },
        {
          id: "reception-58",
          title: "The Sing Along",
          type: "video",
          vibe: "chaos",
          prompt: "Record 6 seconds of a group singing along.",
        },
        {
          id: "reception-59",
          title: "The Dance Circle",
          type: "video",
          vibe: "medium",
          prompt: "Capture a 6-second dance circle moment.",
        },
        {
          id: "reception-60",
          title: "The Slow Motion Move",
          type: "video",
          vibe: "medium",
          prompt: "Record one dance move in slow motion (5 seconds).",
        },
        {
          id: "reception-61",
          title: "Outfit Detail",
          type: "photo",
          vibe: "easy",
          prompt: "Close-up of a great detail: pocket square, nails, jewelry.",
        },
        {
          id: "reception-62",
          title: "The Best Hair",
          type: "photo",
          vibe: "easy",
          prompt: "Photo of the best hair moment (with consent).",
        },
        {
          id: "reception-63",
          title: "The DJ Booth",
          type: "photo",
          vibe: "medium",
          prompt: "Photograph the DJ setup or speakers (if accessible).",
        },
        {
          id: "reception-64",
          title: "The Dinner Plate",
          type: "photo",
          vibe: "easy",
          prompt: "Take a quick photo of dinner before the first bite.",
        },
        {
          id: "reception-65",
          title: "The Dessert Reveal",
          type: "photo",
          vibe: "medium",
          prompt: "Photo of dessert when it arrives.",
        },
        {
          id: "reception-66",
          title: "The Clap Moment",
          type: "video",
          vibe: "easy",
          prompt: "5-second clip of applause after something big.",
        },
        {
          id: "reception-67",
          title: "The Couple Cameo",
          type: "photo",
          vibe: "chaos",
          prompt: "Photo with Zack/Sean in the background without interrupting.",
        },
        {
          id: "reception-68",
          title: "The Group Wave",
          type: "video",
          vibe: "easy",
          prompt: "Record a 5-second group wave to the camera.",
        },
        {
          id: "reception-69",
          title: "The Dance Partner Switch",
          type: "video",
          vibe: "chaos",
          prompt: "Capture a 6-second partner switch moment.",
        },
        {
          id: "reception-70",
          title: "The Line Dance",
          type: "video",
          vibe: "medium",
          prompt: "Capture 6 seconds of a line dance (if it happens).",
        },
        {
          id: "reception-71",
          title: "The Floor Wide",
          type: "photo",
          vibe: "easy",
          prompt: "Wide shot of the reception room vibes.",
        },
        {
          id: "reception-72",
          title: "The Table Details",
          type: "photo",
          vibe: "easy",
          prompt: "Photo of your table: centerpiece + place setting.",
        },
        {
          id: "reception-73",
          title: "The One Great Candid",
          type: "photo",
          vibe: "medium",
          prompt: "Get one candid you’d frame. No posing.",
        },
        {
          id: "reception-74",
          title: "The Photo Bomb",
          type: "photo",
          vibe: "chaos",
          prompt: "Create a harmless, funny photobomb (keep it respectful).",
        },
        {
          id: "reception-75",
          title: "The Best Laugh",
          type: "photo",
          vibe: "medium",
          prompt: "Capture the biggest laugh during reception.",
        },
        {
          id: "reception-76",
          title: "The Cheers at Night",
          type: "photo",
          vibe: "easy",
          prompt: "Nightcap cheers photo with your group.",
        },
        {
          id: "reception-77",
          title: "The Confetti Energy",
          type: "video",
          vibe: "medium",
          prompt: "Record 6 seconds of high energy (jumping, cheering).",
        },
        {
          id: "reception-78",
          title: "The Dancefloor Feet",
          type: "photo",
          vibe: "medium",
          prompt: "Photo of dancing feet only (no faces).",
        },
        {
          id: "reception-79",
          title: "The Shadow Silhouette",
          type: "photo",
          vibe: "chaos",
          prompt: "Try a silhouette shot against bright lights.",
        },
        {
          id: "reception-80",
          title: "The Epic Duo",
          type: "photo",
          vibe: "easy",
          prompt: "Photo of two people dancing like it’s their moment.",
        },
        {
          id: "reception-81",
          title: "The Hype Train",
          type: "video",
          vibe: "chaos",
          prompt: "6-second clip of a hype train moving through the floor.",
        },
        {
          id: "reception-82",
          title: "The Pose Freeze",
          type: "video",
          vibe: "medium",
          prompt: "Record a 5-second freeze pose challenge.",
        },
        {
          id: "reception-83",
          title: "The Camera Pass",
          type: "video",
          vibe: "chaos",
          prompt: "Pass the phone to 4 people saying ‘Congrats!’ in one clip.",
        },
        {
          id: "reception-84",
          title: "The Best Spin",
          type: "video",
          vibe: "medium",
          prompt: "Capture a spin move (5 seconds).",
        },
        {
          id: "reception-85",
          title: "The High Five Chain",
          type: "video",
          vibe: "medium",
          prompt: "Record a high-five chain (5–7 seconds).",
        },
        {
          id: "reception-86",
          title: "The Big Group Photo",
          type: "photo",
          vibe: "chaos",
          prompt: "Find 8+ people and do a big group photo.",
        },
        {
          id: "reception-87",
          title: "The Family Moment",
          type: "photo",
          vibe: "medium",
          prompt: "Capture a sweet family hug or moment.",
        },
        {
          id: "reception-88",
          title: "The Dance Floor Selfie",
          type: "photo",
          vibe: "easy",
          prompt: "Selfie with the dance floor behind you.",
        },
        {
          id: "reception-89",
          title: "The Song Reaction",
          type: "video",
          vibe: "easy",
          prompt: "Ask someone their favorite song tonight (5 seconds).",
        },
        {
          id: "reception-90",
          title: "The Air Guitar",
          type: "video",
          vibe: "chaos",
          prompt: "6-second air guitar performance.",
        },
        {
          id: "reception-91",
          title: "The Air Mic",
          type: "video",
          vibe: "chaos",
          prompt: "6-second pretend microphone performance.",
        },
        {
          id: "reception-92",
          title: "The Group Jump",
          type: "photo",
          vibe: "chaos",
          prompt: "Photo of a group jumping (attempt 2 max).",
        },
        {
          id: "reception-93",
          title: "The Serious Formal",
          type: "photo",
          vibe: "chaos",
          prompt: "Everyone looks extremely formal and serious on the dance floor.",
        },
        {
          id: "reception-94",
          title: "The Tilt Shot",
          type: "photo",
          vibe: "medium",
          prompt: "Take an angled tilt shot that still looks good.",
        },
        {
          id: "reception-95",
          title: "The Candid Toast",
          type: "photo",
          vibe: "medium",
          prompt: "Photo of someone raising a glass candidly.",
        },
        {
          id: "reception-96",
          title: "The Best Backdrop",
          type: "photo",
          vibe: "medium",
          prompt: "Find the best backdrop in the room and take a group photo.",
        },
        {
          id: "reception-97",
          title: "The Glow Shot",
          type: "photo",
          vibe: "medium",
          prompt: "Use warm lighting for a flattering glow photo.",
        },
        {
          id: "reception-98",
          title: "The Moment of Calm",
          type: "photo",
          vibe: "easy",
          prompt: "Capture a quiet candid away from the floor.",
        },
        {
          id: "reception-99",
          title: "The Best Duo Pose",
          type: "photo",
          vibe: "easy",
          prompt: "Two friends do their best duo pose.",
        },
        {
          id: "reception-100",
          title: "The Final Frame",
          type: "video",
          vibe: "medium",
          prompt: "Record a 6-second ‘thank you / goodnight’ clip for the couple.",
        },
      ],
    },
  },
};

const state = {
  segment: "cocktail",
  activeIds: [],
  filters: {
    type: "all",
    vibe: "all",
  },
  completedIds: new Set(),
  seenIds: new Set(),
};

const seenStorageKey = "wedding-seen-ids";
const completedStorageKey = "wedding-completed-ids";

const getChallengeButton = document.getElementById("get-challenge");
const shuffleButton = document.getElementById("shuffle");
const challengeGrid = document.getElementById("challenge-grid");
const completedToggle = document.getElementById("completed-toggle");
const completedPanel = document.getElementById("completed-panel");
const completedList = document.getElementById("completed-list");
const statusMessage = document.getElementById("status-message");
const segmentToggle = document.getElementById("segment-toggle");

const modal = document.getElementById("modal");
const modalTitle = document.getElementById("modal-title");
const modalPrompt = document.getElementById("modal-prompt");
const modalMeta = document.getElementById("modal-meta");
const modalDone = document.getElementById("modal-done");
const modalNew = document.getElementById("modal-new");
let modalActiveId = null;

const filterButtons = document.querySelectorAll("[data-filter]");
const segmentButtons = document.querySelectorAll("[data-segment]");

const parseTime = (timeString) => {
  const [hour, minute] = timeString.split(":").map(Number);
  return { hour, minute };
};

const getLocalDateTime = () => {
  const formatter = new Intl.DateTimeFormat("en-US", {
    timeZone: data.meta.timezone,
    year: "numeric",
    month: "2-digit",
    day: "2-digit",
    hour: "2-digit",
    minute: "2-digit",
    hour12: false,
  });
  const parts = Object.fromEntries(
    formatter.formatToParts(new Date()).map((part) => [part.type, part.value])
  );
  return {
    year: Number(parts.year),
    month: Number(parts.month),
    day: Number(parts.day),
    hour: Number(parts.hour),
    minute: Number(parts.minute),
  };
};

const isWithinWindow = (current, start, end) => {
  const currentMinutes = current.hour * 60 + current.minute;
  const startMinutes = start.hour * 60 + start.minute;
  const endMinutes = end.hour * 60 + end.minute;
  return currentMinutes >= startMinutes && currentMinutes < endMinutes;
};

const determineSegment = () => {
  const now = getLocalDateTime();
  const isEventDay = now.year === 2026 && now.month === 2 && now.day === 21;

  if (!isEventDay) {
    return null;
  }

  const cocktailWindow = data.segments.cocktail;
  const receptionWindow = data.segments.reception;

  if (isWithinWindow(now, parseTime(cocktailWindow.start), parseTime(cocktailWindow.end))) {
    return "cocktail";
  }

  if (isWithinWindow(now, parseTime(receptionWindow.start), parseTime(receptionWindow.end))) {
    return "reception";
  }

  return null;
};

const loadStorage = () => {
  const storedSeen = JSON.parse(localStorage.getItem(seenStorageKey) || "[]");
  const storedCompleted = JSON.parse(localStorage.getItem(completedStorageKey) || "[]");
  state.seenIds = new Set(storedSeen);
  state.completedIds = new Set(storedCompleted);
};

const saveStorage = () => {
  localStorage.setItem(seenStorageKey, JSON.stringify(Array.from(state.seenIds)));
  localStorage.setItem(completedStorageKey, JSON.stringify(Array.from(state.completedIds)));
};

const getFilteredChallenges = () => {
  const segmentItems = data.segments[state.segment].items;
  return segmentItems.filter((item) => {
    const typeMatch =
      state.filters.type === "all" ||
      state.filters.type === "either" ||
      item.type === state.filters.type;
    const vibeMatch = state.filters.vibe === "all" || item.vibe === state.filters.vibe;
    return typeMatch && vibeMatch;
  });
};

const pickChallenges = (count = 6) => {
  const pool = getFilteredChallenges();
  if (pool.length === 0) {
    return [];
  }

  const unseen = pool.filter((item) => !state.seenIds.has(item.id));
  const seenCount = pool.length - unseen.length;
  const allowRepeats = seenCount / pool.length >= 0.8;
  const candidates = allowRepeats ? pool : unseen;

  const selection = [];
  const usedIds = new Set(state.activeIds);
  const mutable = [...candidates];

  while (selection.length < count && mutable.length > 0) {
    const index = Math.floor(Math.random() * mutable.length);
    const item = mutable.splice(index, 1)[0];
    if (usedIds.has(item.id) && mutable.length > 0) {
      continue;
    }
    selection.push(item);
    usedIds.add(item.id);
  }

  if (selection.length < count) {
    const fallback = pool.filter((item) => !usedIds.has(item.id));
    while (selection.length < count && fallback.length > 0) {
      const index = Math.floor(Math.random() * fallback.length);
      selection.push(fallback.splice(index, 1)[0]);
    }
  }

  selection.forEach((item) => state.seenIds.add(item.id));
  saveStorage();
  return selection;
};

const renderChallenges = (items) => {
  challengeGrid.innerHTML = "";
  if (items.length === 0) {
    const empty = document.createElement("p");
    empty.textContent = "No challenges match these filters. Try resetting to All.";
    empty.className = "lead";
    challengeGrid.appendChild(empty);
    return;
  }

  items.forEach((item) => {
    const card = document.createElement("button");
    card.type = "button";
    card.className = "challenge-card";
    card.setAttribute("role", "listitem");
    card.dataset.id = item.id;
    card.innerHTML = `
      <div class="challenge-card__meta">
        <span>${item.type}</span>
        <span>${item.vibe}</span>
      </div>
      <h3>${item.title}</h3>
      <p>${item.prompt}</p>
    `;
    card.addEventListener("click", () => openModal(item));
    challengeGrid.appendChild(card);
  });
};

const renderCompleted = () => {
  completedList.innerHTML = "";
  const completedItems = data.segments[state.segment].items.filter((item) =>
    state.completedIds.has(item.id)
  );

  if (completedItems.length === 0) {
    const emptyItem = document.createElement("li");
    emptyItem.textContent = "No completed challenges yet.";
    completedList.appendChild(emptyItem);
  } else {
    completedItems.forEach((item) => {
      const li = document.createElement("li");
      li.textContent = item.title;
      completedList.appendChild(li);
    });
  }

  completedToggle.textContent = `Completed (${state.completedIds.size})`;
};

const updateSegmentUI = (segment) => {
  segmentButtons.forEach((button) => {
    const isActive = button.dataset.segment === segment;
    button.classList.toggle("is-active", isActive);
  });
};

const refreshChallenges = () => {
  const selection = pickChallenges();
  state.activeIds = selection.map((item) => item.id);
  renderChallenges(selection);
  renderCompleted();
};

const openModal = (item) => {
  modalActiveId = item.id;
  modalTitle.textContent = item.title;
  modalPrompt.textContent = item.prompt;
  modalMeta.textContent = `${item.type} · ${item.vibe}`;
  modal.classList.add("is-open");
  modal.setAttribute("aria-hidden", "false");
  modalDone.focus();
};

const closeModal = () => {
  modal.classList.remove("is-open");
  modal.setAttribute("aria-hidden", "true");
  modalActiveId = null;
};

const markCompleted = () => {
  if (!modalActiveId) return;
  state.completedIds.add(modalActiveId);
  saveStorage();
  renderCompleted();
};

const setFilters = (filter, value) => {
  state.filters[filter] = value;
  filterButtons.forEach((button) => {
    if (button.dataset.filter !== filter) return;
    button.classList.toggle("is-active", button.dataset.value === value);
  });
  refreshChallenges();
};

const updateStatusMessage = (segmentOverride) => {
  if (segmentOverride) {
    statusMessage.textContent = `Showing ${segmentOverride === "cocktail" ? "Cocktail Hour" : "Reception"} prompts. Tap shuffle any time.`;
    return;
  }
  const activeSegment = determineSegment();
  if (activeSegment) {
    statusMessage.textContent = `It’s currently ${activeSegment === "cocktail" ? "Cocktail Hour" : "Reception"}. Prompts are matched to this window.`;
  } else {
    statusMessage.textContent = "Outside the scheduled windows. Pick a moment to start.";
  }
};

const initializeSegment = () => {
  const activeSegment = determineSegment();
  if (activeSegment) {
    state.segment = activeSegment;
    segmentToggle.hidden = true;
    updateStatusMessage(activeSegment);
  } else {
    segmentToggle.hidden = false;
    updateStatusMessage(null);
  }
  updateSegmentUI(state.segment);
};

filterButtons.forEach((button) => {
  button.addEventListener("click", () => {
    setFilters(button.dataset.filter, button.dataset.value);
  });
});

segmentButtons.forEach((button) => {
  button.addEventListener("click", () => {
    state.segment = button.dataset.segment;
    updateSegmentUI(state.segment);
    updateStatusMessage(state.segment);
    refreshChallenges();
  });
});

getChallengeButton.addEventListener("click", () => {
  refreshChallenges();
  challengeGrid.scrollIntoView({ behavior: "smooth", block: "start" });
});

shuffleButton.addEventListener("click", refreshChallenges);

completedToggle.addEventListener("click", () => {
  completedPanel.hidden = !completedPanel.hidden;
});

modal.addEventListener("click", (event) => {
  if (event.target.dataset.close) {
    closeModal();
  }
});

modalNew.addEventListener("click", () => {
  refreshChallenges();
  closeModal();
});

modalDone.addEventListener("click", () => {
  markCompleted();
  closeModal();
});

document.addEventListener("keydown", (event) => {
  if (event.key === "Escape" && modal.classList.contains("is-open")) {
    closeModal();
  }
});

loadStorage();
initializeSegment();
refreshChallenges();
